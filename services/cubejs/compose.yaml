services:
  cubejs:
    image: cubejs/cube:latest
    profiles: ["cubejs"]
    ports:
      - "${CUBEJS_PORT:-4000}:4000"
    environment:
      CUBEJS_DEV_MODE: ${CUBEJS_DEV_MODE:-true}
      CUBEJS_API_SECRET: ${CUBEJS_API_SECRET:-secret}
      CUBEJS_DB_TYPE: ${CUBEJS_DB_TYPE:-postgres}
      CUBEJS_DB_HOST: ${CUBEJS_DB_HOST:-postgres}
      CUBEJS_DB_PORT: ${CUBEJS_DB_PORT:-5432}
      CUBEJS_DB_NAME: ${CUBEJS_DB_NAME:-analytics}
      CUBEJS_DB_USER: ${CUBEJS_DB_USER:-analyticsUser}
      CUBEJS_DB_PASS: ${CUBEJS_DB_PASS:-analyticsPass}
    volumes:
      - ./services/cubejs/schema:/cube/conf/schema
      - cubejs-data:/cube/conf
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:4000/readyz', r => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - ecosystem

volumes:
  cubejs-data:
